<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة سايبر كيان (بدون انترنت)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Cairo for Arabic) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <style>
        /* Custom styles and theme variables */
        body {
            font-family: 'Cairo', sans-serif;
            --color-bg: #1e1e1e;
            --color-panel: #2d2d2d;
            --color-primary: #00aaff;
            --color-accent: #00ffaa;
            --color-text: #e0e0e0;
            --color-danger: #ff5555;
            --color-warn: #ffaa00;
            --color-success: #22c55e;
        }
        .bg-main { background-color: var(--color-bg); }
        .bg-panel { background-color: var(--color-panel); }
        .text-primary { color: var(--color-primary); }
        .text-accent { color: var(--color-accent); }
        .text-main { color: var(--color-text); }
        .text-danger { color: var(--color-danger); }
        .text-warn { color: var(--color-warn); }
        .border-accent { border-color: var(--color-accent); }
        .border-danger { border-color: var(--color-danger); }
        .shadow-accent { box-shadow: 0 0 15px var(--color-accent); }
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-bg);
            transition: all 0.2s ease-in-out;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--color-accent);
            transform: translateY(-2px);
        }
        .btn-danger {
             background-color: var(--color-danger);
            color: var(--color-text);
        }
        .btn-danger:hover:not(:disabled) {
            background-color: #ff2222;
        }
        .btn-secondary {
            background-color: #4a4a4a;
            color: var(--color-text);
        }
        .btn-success {
            background-color: var(--color-success);
            color: var(--color-bg);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 170, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 170, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 170, 0); }
        }
        .animate-pulse-once { animation: pulse 1.5s; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--color-panel); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--color-primary); }
         /* Spinner for loading state */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-main text-main">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-main">
        <div class="bg-panel p-8 rounded-lg shadow-lg w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center text-primary mb-6">سايبر كيان - تسجيل الدخول</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block mb-2 text-sm font-medium">اسم المستخدم (إيميل)</label>
                    <input type="email" id="email" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" placeholder="user@example.com" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block mb-2 text-sm font-medium">كلمة المرور</label>
                    <input type="password" id="password" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5" required>
                </div>
                <button type="submit" class="w-full btn-primary font-bold rounded-lg text-sm px-5 py-2.5 text-center">تسجيل الدخول</button>
                 <p id="login-error" class="text-danger text-center mt-4 text-sm"></p>
            </form>
        </div>
    </div>

    <!-- Main Application Screen (Initially Hidden) -->
    <div id="app-screen" class="hidden">
        <header class="bg-panel p-4 shadow-md flex justify-between items-center sticky top-0 z-50">
            <div>
                <h1 class="text-2xl font-bold text-primary">لوحة تحكم سايبر كيان</h1>
                <p class="text-sm text-gray-400">المستخدم الحالي: <span id="current-user" class="font-bold"></span></p>
            </div>
            <div class="flex items-center gap-4 md:gap-6 text-sm md:text-base">
                 <div class="text-center">
                    <button id="shift-btn" class="font-bold px-4 py-2 rounded-lg"></button>
                </div>
                <div class="text-center">
                    <span class="text-gray-400 block">إيرادات الشيفت</span>
                    <span id="revenue-label" class="font-bold text-accent">0.00 EGP</span>
                </div>
                 <div class="text-center">
                    <span class="text-gray-400 block">مصروفات الشيفت</span>
                    <span id="expenses-label" class="font-bold text-danger">0.00 EGP</span>
                </div>
                 <div class="text-center">
                    <span class="text-gray-400 block">صافي الشيفت</span>
                    <span id="net-label" class="font-bold text-white">0.00 EGP</span>
                </div>
                 <!-- Notification Bell -->
                <div id="notification-container" class="relative hidden">
                    <button id="notification-bell-btn" class="text-xl text-gray-300 hover:text-white">
                        <i class="fa-solid fa-bell"></i>
                        <span id="notification-badge" class="hidden absolute -top-1 -right-1 bg-danger text-white text-xs rounded-full h-4 w-4 flex items-center justify-center"></span>
                    </button>
                    <div id="notification-panel" class="hidden absolute top-full left-0 mt-2 w-80 bg-panel border border-gray-600 rounded-lg shadow-lg z-50">
                        <div class="p-2 border-b border-gray-600 font-bold">الإشعارات</div>
                        <div id="notification-list" class="max-h-96 overflow-y-auto">
                            <!-- Notifications will be rendered here -->
                        </div>
                    </div>
                </div>
                <button id="admin-panel-btn" class="hidden bg-warn text-black px-4 py-2 rounded-lg font-bold hover:bg-yellow-500">لوحة التحكم</button>
                <button id="logout-btn" class="bg-danger text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 transition-colors">تسجيل الخروج</button>
            </div>
        </header>

        <main class="p-4 md:p-6 relative">
            <div id="no-shift-overlay" class="hidden absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center z-40">
                <p class="text-2xl font-bold text-warn">يرجى بدء الشيفت لتفعيل الأجهزة</p>
            </div>
            <div id="devices-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <!-- Device cards will be dynamically inserted here -->
            </div>
        </main>
    </div>
    
    <!-- Modals Container -->
    <div id="start-session-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-panel rounded-lg shadow-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 text-primary">بدء جلسة جديدة لـ <span id="modal-device-name"></span></h3>
            <form id="start-session-form">
                <div class="mb-4"><label class="block mb-2">نوع الجلسة</label><div id="session-type-options" class="flex gap-4"></div></div>
                <div class="mb-4"><label class="block mb-2">مدة الجلسة</label><div class="flex gap-2 flex-wrap" id="time-options"></div></div>
                <div id="manual-time-input-container" class="mb-4 hidden"><label for="manual-minutes">أدخل الدقائق يدويًا</label><input type="number" id="manual-minutes" class="bg-gray-700 w-full p-2 rounded" min="1"></div>
                <div class="mb-4"><label for="customer-name">اسم العميل (اختياري)</label><input type="text" id="customer-name" class="bg-gray-700 w-full p-2 rounded"></div>
                <div class="flex justify-end gap-4 mt-6"><button type="button" id="cancel-start-session" class="btn-secondary px-4 py-2 rounded-lg">إلغاء</button><button type="submit" class="btn-primary px-4 py-2 rounded-lg font-bold">بدء الجلسة</button></div>
            </form>
        </div>
    </div>
    
    <div id="add-item-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-panel rounded-lg shadow-lg p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-primary">إضافة مشروب/منتج</h3>
            <div id="item-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
            <div class="flex justify-end mt-6"><button type="button" id="cancel-add-item" class="btn-secondary px-4 py-2 rounded-lg">إغلاق</button></div>
        </div>
    </div>

    <div id="end-session-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-panel rounded-lg shadow-lg p-6 w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-2 text-warn">تأكيد الإنهاء</h3>
            <p class="mb-6">هل أنت متأكد أنك تريد إنهاء الجلسة لجهاز <span id="end-modal-device-name" class="font-bold"></span>؟</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-end-session" class="btn-secondary px-6 py-2 rounded-lg">إلغاء</button>
                <button id="confirm-end-session" class="btn-danger px-6 py-2 rounded-lg font-bold">نعم، قم بالإنهاء</button>
            </div>
        </div>
    </div>
    
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-panel rounded-lg shadow-lg p-6 w-full max-w-sm text-center">
            <p id="notification-message" class="mb-6 text-lg"></p>
            <button id="notification-ok-btn" class="btn-primary px-8 py-2 rounded-lg font-bold">حسنًا</button>
        </div>
    </div>

    <!-- Gemini Summary Modal -->
    <div id="summary-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[70] hidden">
        <div class="bg-panel rounded-lg shadow-lg p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-primary">✨ ملخص الشيفت الذكي</h3>
                <button id="close-summary-modal" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div id="summary-content-container" class="min-h-[150px] flex items-center justify-center">
                <div id="summary-loader" class="loader hidden"></div>
                <p id="summary-content" class="text-main leading-relaxed"></p>
            </div>
        </div>
    </div>


    <!-- Admin Panel Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[60] hidden">
        <div class="bg-panel rounded-lg shadow-lg p-6 w-full max-w-5xl h-5/6 flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-gray-700 pb-3">
                <h3 class="text-2xl font-bold text-primary">لوحة تحكم المدير</h3>
                <button id="close-admin-modal" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <!-- Tabs -->
            <div class="flex border-b border-gray-600 mb-4">
                <button class="admin-tab-btn flex-1 py-2 text-center border-b-2 border-primary" data-tab="user-management">إدارة المستخدمين</button>
                <button class="admin-tab-btn flex-1 py-2 text-center border-b-2 border-transparent text-gray-400" data-tab="shift-history">سجل الشيفتات</button>
                <button class="admin-tab-btn flex-1 py-2 text-center border-b-2 border-transparent text-gray-400" data-tab="activity-log">سجل النشاط</button>
            </div>
            <!-- Tab Content -->
            <div class="flex-grow overflow-y-auto">
                 <div id="user-management-tab" class="admin-tab-content"><h4 class="text-xl font-bold mb-4">إدارة المستخدمين</h4><div id="user-list-container" class="space-y-4"></div></div>
                 <div id="shift-history-tab" class="admin-tab-content hidden"><h4 class="text-xl font-bold mb-4">سجل الشيftات</h4><div id="shift-history-container" class="space-y-4"></div></div>
                 <div id="activity-log-tab" class="admin-tab-content hidden">
                    <div class="flex justify-between items-center mb-4"><h4 id="activity-log-title" class="text-xl font-bold"></h4><button id="show-all-activity-btn" class="btn-secondary px-4 py-1 rounded hidden">عرض الكل</button></div>
                    <div id="activity-log-container" class="space-y-2 font-mono text-sm pr-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const adminEmail = "admin@kayan.com";

            // --- !!! إعدادات بوت التليجرام - مهم جداً !!! ---
            const TELEGRAM_BOT_TOKEN = '7579810847:AAFwgE2cpCsakNt_pHZYOD1g3Db8sUYJ86I'; 
            const TELEGRAM_CHAT_ID = '6325158235';     


            const kayanDevicesSetup = [
                { name: "PS7", type: "PlayStation_Premium" }, { name: "PS8", type: "PlayStation_Premium" },
                { name: "PS9", type: "PlayStation_Premium" }, { name: "PS10", type: "PlayStation_Premium" },
            ];
            const deviceRates = { "PlayStation_Premium": { "Single": 40.0, "Multiplayer": 60.0 } };
            const itemPrices = {"اندومي": 20, "شاي": 10, "قهوه": 20, "بيبسي": 20, "ينسون": 15, "نعناع": 15, "ناسكافيه": 15};

            // --- DOM ELEMENTS ---
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const currentUserSpan = document.getElementById('current-user');
            const logoutBtn = document.getElementById('logout-btn');
            const adminPanelBtn = document.getElementById('admin-panel-btn');
            const shiftBtn = document.getElementById('shift-btn');
            const devicesContainer = document.getElementById('devices-container');
            const revenueLabel = document.getElementById('revenue-label');
            const expensesLabel = document.getElementById('expenses-label');
            const netLabel = document.getElementById('net-label');
            const noShiftOverlay = document.getElementById('no-shift-overlay');
            
            const startSessionModal = document.getElementById('start-session-modal');
            const addItemModal = document.getElementById('add-item-modal');
            const endSessionModal = document.getElementById('end-session-modal');
            const notificationModal = document.getElementById('notification-modal');
            const adminModal = document.getElementById('admin-modal');
            const summaryModal = document.getElementById('summary-modal');

            const notificationMessage = document.getElementById('notification-message');
            const notificationOkBtn = document.getElementById('notification-ok-btn');
            const notificationContainer = document.getElementById('notification-container');
            const notificationBellBtn = document.getElementById('notification-bell-btn');
            const notificationBadge = document.getElementById('notification-badge');
            const notificationPanel = document.getElementById('notification-panel');
            const notificationList = document.getElementById('notification-list');


            let currentDeviceToStart = null, currentDeviceToAddItem = null, currentDeviceToEnd = null;
            let appState = {};
            let activityLogFilter = null;

            // --- STATE MANAGEMENT ---
            function saveState() {
                localStorage.setItem('kayanCyberState', JSON.stringify(appState));
            }

            function loadState() {
                const savedState = localStorage.getItem('kayanCyberState');
                if (savedState) {
                    appState = JSON.parse(savedState);
                } else {
                    appState = {
                        sessions: {},
                        financials: { revenue: 0, expenses: 0 },
                        shiftActive: false,
                        shiftHistory: [],
                        users: {
                            "admin@kayan.com": { password: "admin123", name: "المدير" },
                            "test@kayan.com": { password: "123456", name: "موظف مؤقت" }
                        },
                        activityLog: [],
                        notifications: []
                    };
                }
                // Backward compatibility
                if (!appState.users) appState.users = { "admin@kayan.com": { password: "admin123", name: "المدير" }, "test@kayan.com": { password: "123456", name: "موظف مؤقت" } };
                if (!appState.activityLog) appState.activityLog = [];
                if (typeof appState.shiftActive === 'undefined') appState.shiftActive = false;
                if (!appState.shiftHistory) appState.shiftHistory = [];
                if (!appState.notifications) appState.notifications = [];

                renderAll();
            }

            // --- NOTIFICATION & LOGGING ---
            async function sendTelegramNotification(action, user, details) {
                const botToken = TELEGRAM_BOT_TOKEN;
                const chatId = TELEGRAM_CHAT_ID;

                if (!botToken || !chatId || botToken === 'YOUR_BOT_TOKEN_HERE' || chatId === 'YOUR_CHAT_ID_HERE') {
                    console.warn("Telegram settings are not configured in the code.");
                    return;
                }

                let mainMessage = `👤 *الموظف:* ${user}\n✨ *الإجراء:* ${action}`;

                switch (action) {
                    case 'بدء جلسة':
                        const time = details.minutes > 0 ? `${details.minutes} دقيقة` : 'وقت مفتوح';
                        const sessionType = details.sessionType === 'Single' ? 'فردي' : 'زوجي';
                        mainMessage += `\n\n*التفاصيل:*\n- الجهاز: ${details.deviceName}\n- العميل: ${details.customerName || 'بدون اسم'}\n- النوع: ${sessionType}\n- الباقة: ${time}`;
                        break;
                    case 'إنهاء جلسة':
                        mainMessage += `\n\n*التفاصيل:*\n- الجهاز: ${details.deviceName}\n- الحساب النهائي: *${details.totalCost}*`;
                        break;
                    case 'إضافة منتج':
                        mainMessage += `\n\n*التفاصيل:*\n- الجهاز: ${details.deviceName}\n- المنتج: ${details.itemName} (${details.itemPrice})`;
                        break;
                    case 'بدء الشيفت':
                        mainMessage = `✅ *${user}* بدأ شيفت جديد.`;
                        break;
                    case 'إنهاء الشيفت':
                        mainMessage = `🏁 *${user}* أنهى الشيفت.\n\n*ملخص الشيفت:*\n- الإيرادات: ${details.revenue} جنيه\n- المصروفات: ${details.expenses} جنيه`;
                        break;
                    default:
                        // Generic message for other actions like password change, login, logout
                        break;
                }

                const currentRevenue = (appState.financials.revenue || 0).toFixed(2);
                const availableDevices = kayanDevicesSetup
                    .filter(d => !appState.sessions[d.name])
                    .map(d => d.name)
                    .join(', ');

                const footer = `\n\n➖➖➖➖\n*وضع حالي:*\n💰 *إيراد الشيفت:* ${currentRevenue} جنيه\n🎮 *أجهزة متاحة:* ${availableDevices || 'لا يوجد'}`;

                const finalMessage = mainMessage + footer;

                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: finalMessage,
                            parse_mode: 'Markdown'
                        })
                    });
                    if (!response.ok) {
                        console.error("Telegram API Error:", await response.json());
                    }
                } catch (error) {
                    console.error("Failed to send Telegram notification:", error);
                }
            }


            function addNotification(message) {
                appState.notifications.unshift({
                    message,
                    timestamp: new Date().toISOString(),
                    read: false
                });
                if (appState.notifications.length > 50) appState.notifications.pop();
            }

            function logActivity(action, details = {}) {
                const userEmail = localStorage.getItem('kayanLoggedInUser') || 'System';
                appState.activityLog.unshift({
                    timestamp: new Date().toISOString(),
                    user: userEmail, action, details
                });
                if (appState.activityLog.length > 100) appState.activityLog.pop();
                
                if (userEmail !== adminEmail) {
                    let notificationMsg = `<b>${userEmail}</b> قام بـ <b>${action}</b>`;
                    if (details.deviceName) notificationMsg += ` للجهاز ${details.deviceName}`;
                    if (details.forUser) notificationMsg += ` للمستخدم ${details.forUser}`;
                    addNotification(notificationMsg);
                    sendTelegramNotification(action, userEmail, details);
                }

                saveState();
            }

            // --- AUTH & SHIFT ---
            function checkLogin() {
                const loggedInUser = localStorage.getItem('kayanLoggedInUser');
                if (loggedInUser && appState.users[loggedInUser]) {
                    showAppUI(appState.users[loggedInUser].name);
                    loadState();
                } else {
                    showLoginUI();
                }
            }

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                loginError.textContent = '';
                const user = appState.users[email];
                if (user && user.password === password) {
                    localStorage.setItem('kayanLoggedInUser', email);
                    logActivity('تسجيل الدخول');
                    checkLogin();
                } else {
                    loginError.textContent = 'كلمة المرور أو الإيميل غير صحيح.';
                }
            });

            logoutBtn.addEventListener('click', () => {
                if(appState.shiftActive) {
                    showNotification("لا يمكن تسجيل الخروج أثناء وجود شيفت مفتوح. يرجى إنهاء الشيفت أولاً.");
                    return;
                }
                logActivity('تسجيل الخروج');
                localStorage.removeItem('kayanLoggedInUser');
                if (window.timerInterval) clearInterval(window.timerInterval);
                checkLogin();
            });

            shiftBtn.addEventListener('click', () => {
                if (appState.shiftActive) { // End shift
                    if (Object.keys(appState.sessions).length > 0) {
                        showNotification('لا يمكن إنهاء الشيفت وهناك جلسات مفتوحة.');
                        return;
                    }
                    const shiftData = {
                        user: localStorage.getItem('kayanLoggedInUser'),
                        startTime: appState.shiftStartTime,
                        endTime: new Date().toISOString(),
                        ...appState.financials
                    };
                    appState.shiftHistory.unshift(shiftData);
                    logActivity('إنهاء الشيفت', { revenue: shiftData.revenue.toFixed(2), expenses: shiftData.expenses.toFixed(2) });
                    appState.shiftActive = false;
                } else { // Start shift
                    appState.shiftActive = true;
                    appState.shiftStartTime = new Date().toISOString();
                    appState.financials = { revenue: 0, expenses: 0 };
                    logActivity('بدء الشيفت');
                }
                saveState();
                renderAll();
            });

            function showAppUI(userName) {
                const loggedInUser = localStorage.getItem('kayanLoggedInUser');
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                currentUserSpan.textContent = userName;
                adminPanelBtn.classList.toggle('hidden', loggedInUser !== adminEmail);
                notificationContainer.classList.toggle('hidden', loggedInUser !== adminEmail);
                if (loggedInUser === adminEmail) renderNotifications();
                if (window.timerInterval) clearInterval(window.timerInterval);
                window.timerInterval = setInterval(updateTimersAndCosts, 1000);
            }

            function showLoginUI() {
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
            }
            
            // --- UI RENDERING ---
            function renderAll() {
                toggleShiftUI();
                renderDevices();
                updateFinancialDisplay();
                if (localStorage.getItem('kayanLoggedInUser') === adminEmail) {
                    renderNotifications();
                }
            }
            
            function toggleShiftUI() {
                noShiftOverlay.classList.toggle('hidden', appState.shiftActive);
                if (appState.shiftActive) {
                    shiftBtn.textContent = 'إنهاء الشيفت';
                    shiftBtn.className = 'font-bold px-4 py-2 rounded-lg btn-danger';
                } else {
                    shiftBtn.textContent = 'بدء الشيفت';
                    shiftBtn.className = 'font-bold px-4 py-2 rounded-lg btn-success';
                }
            }

            function renderDevices() {
                devicesContainer.innerHTML = ''; 
                kayanDevicesSetup.forEach(device => {
                    const session = appState.sessions[device.name];
                    const isActive = !!session;
                    let cardBorderClass = isActive ? (session.endTime && new Date() > new Date(session.endTime) ? 'border-danger' : 'border-accent') : 'border-transparent';
                    const card = document.createElement('div');
                    card.className = `bg-panel p-4 rounded-lg shadow-md border-2 transition-all ${cardBorderClass}`;
                    if (isActive && !card.dataset.animated) {
                        card.classList.add('animate-pulse-once');
                        card.dataset.animated = 'true';
                    }
                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2"><h2 class="text-xl font-bold">${device.name}</h2><span class="text-xs font-bold px-2 py-1 rounded ${isActive ? 'bg-accent text-black' : 'bg-gray-600 text-gray-300'}">${isActive ? 'مشغول' : 'متاح'}</span></div>
                        <div class="text-center my-4"><p class="text-4xl font-mono timer-display">${isActive ? '00:00:00' : '--:--:--'}</p><p class="text-xs text-gray-400 customer-display h-4">${isActive ? ('<i class="fa-solid fa-user"></i> ' + session.customer) : ' '}</p></div>
                        <div class="text-center mb-4"><p class="text-lg font-bold text-warn cost-display">0.00 EGP</p></div>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="start-btn col-span-3 btn-primary py-2 rounded-lg font-bold" data-device-name="${device.name}" data-device-type="${device.type}" ${isActive ? 'disabled' : ''}><i class="fa-solid fa-play"></i> بدء</button>
                            <button class="end-btn btn-danger py-2 rounded-lg font-bold" data-device-name="${device.name}" ${!isActive ? 'disabled' : ''}><i class="fa-solid fa-stop"></i> إنهاء</button>
                            <button class="item-btn col-span-2 btn-secondary py-2 rounded-lg" data-device-name="${device.name}" ${!isActive ? 'disabled' : ''}><i class="fa-solid fa-mug-saucer"></i> إضافة مشروب</button>
                        </div>`;
                    devicesContainer.appendChild(card);
                });
            }
            
            function updateFinancialDisplay() {
                const { revenue = 0, expenses = 0 } = appState.financials;
                revenueLabel.textContent = `${revenue.toFixed(2)} EGP`;
                expensesLabel.textContent = `${expenses.toFixed(2)} EGP`;
                netLabel.textContent = `${(revenue - expenses).toFixed(2)} EGP`;
            }

            function updateTimersAndCosts() {
                document.querySelectorAll('.start-btn').forEach(btn => {
                    const deviceName = btn.dataset.deviceName;
                    const card = btn.closest('.bg-panel');
                    if (!card) return;
                    const timerEl = card.querySelector('.timer-display');
                    const costEl = card.querySelector('.cost-display');
                    const session = appState.sessions[deviceName];
                    if (!session) return;
                    const now = new Date(), startTime = new Date(session.startTime);
                    if (session.endTime) {
                        const endTime = new Date(session.endTime);
                        const remaining = endTime - now;
                        if (remaining > 0) {
                            const h = Math.floor(remaining / 3600000), m = Math.floor((remaining % 3600000) / 60000), s = Math.floor((remaining % 60000) / 1000);
                            timerEl.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                        } else { timerEl.textContent = '00:00:00'; }
                    } else {
                        const elapsed = now - startTime;
                        if (elapsed < 0) return;
                        const h = Math.floor(elapsed / 3600000), m = Math.floor((elapsed % 3600000) / 60000), s = Math.floor((elapsed % 60000) / 1000);
                        timerEl.textContent = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                    }
                    const timeCost = ((now - startTime) / 3600000) * (deviceRates[session.deviceType]?.[session.sessionType] || 0);
                    costEl.textContent = `${(timeCost + session.itemCost).toFixed(2)} EGP`;
                });
            }

            // --- CORE FUNCTIONALITY ---
            function startSession(deviceName, deviceType, sessionType, minutes, customerName) {
                const startTime = new Date();
                const endTime = minutes > 0 ? new Date(startTime.getTime() + minutes * 60000) : null;
                appState.sessions[deviceName] = { deviceType, sessionType, customer: customerName || "عميل كاش", startTime: startTime.toISOString(), endTime: endTime ? endTime.toISOString() : null, itemCost: 0, items: [] };
                logActivity('بدء جلسة', { deviceName, customerName, sessionType, minutes: minutes > 0 ? minutes : 'مفتوح' });
                saveState(); renderAll(); hideStartSessionModal();
            }
            
            function endSession(deviceName) {
                const session = appState.sessions[deviceName];
                if (!session) { showNotification("خطأ: الجلسة غير موجودة."); return; }
                const timeCost = ((new Date() - new Date(session.startTime)) / 3600000) * (deviceRates[session.deviceType]?.[session.sessionType] || 0);
                const totalCost = Math.ceil(timeCost + session.itemCost);
                appState.financials.revenue += totalCost;
                delete appState.sessions[deviceName];
                logActivity('إنهاء جلسة', { deviceName, totalCost: `${totalCost.toFixed(2)} جنيه` });
                saveState(); renderAll();
                showNotification(`تم إنهاء الجلسة لجهاز ${deviceName}<br>الإجمالي المطلوب: ${totalCost.toFixed(2)} جنيه`);
            }
            
            function addItemToSession(deviceName, itemName, itemPrice) {
                const session = appState.sessions[deviceName];
                if (session) {
                    session.itemCost += itemPrice;
                    session.items.push(itemName);
                    logActivity('إضافة منتج', { deviceName, itemName, itemPrice: `${itemPrice.toFixed(2)} جنيه` });
                    saveState(); renderAll(); hideAddItemModal();
                } else { showNotification("حدث خطأ أثناء إضافة المنتج."); }
            }

            // --- MODALS & UI ---
            function showNotification(message) {
                notificationMessage.innerHTML = message;
                notificationModal.classList.remove('hidden');
            }
            notificationOkBtn.addEventListener('click', () => notificationModal.classList.add('hidden'));

            devicesContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn || btn.disabled) return;
                const deviceName = btn.dataset.deviceName;
                if (btn.classList.contains('start-btn')) showStartSessionModal(deviceName, btn.dataset.deviceType);
                if (btn.classList.contains('end-btn')) showEndSessionConfirmation(deviceName);
                if (btn.classList.contains('item-btn')) showAddItemModal(deviceName);
            });

            function showStartSessionModal(deviceName, deviceType) {
                currentDeviceToStart = { name: deviceName, type: deviceType };
                document.getElementById('modal-device-name').textContent = deviceName;
                document.getElementById('session-type-options').innerHTML = Object.keys(deviceRates[deviceType]).map((type, i) => `<div><input type="radio" name="sessionType" value="${type}" id="type-${type}" ${i === 0 ? 'checked' : ''}><label for="type-${type}" class="ms-2 text-lg">${type === 'Single' ? 'فردي' : 'زوجي'}</label></div>`).join('');
                document.getElementById('time-options').innerHTML = `<button type="button" class="time-option-btn flex-1 btn-primary p-2 rounded" data-minutes="0">مفتوح</button><button type="button" class="time-option-btn flex-1 btn-secondary p-2 rounded" data-minutes="30">30 د</button><button type="button" class="time-option-btn flex-1 btn-secondary p-2 rounded" data-minutes="60">60 د</button><button type="button" class="time-option-btn flex-1 btn-secondary p-2 rounded" data-minutes="manual">مخصص</button>`;
                startSessionModal.classList.remove('hidden');
                document.getElementById('manual-time-input-container').classList.add('hidden');
            }
            function hideStartSessionModal() { document.getElementById('start-session-form').reset(); startSessionModal.classList.add('hidden'); }
            
            function showAddItemModal(deviceName) {
                currentDeviceToAddItem = deviceName;
                document.getElementById('item-list').innerHTML = Object.entries(itemPrices).map(([name, price]) => `<button class="item-select-btn w-full text-right p-3 rounded bg-gray-700 hover:bg-primary hover:text-black" data-name="${name}" data-price="${price}">${name} - ${price.toFixed(2)} EGP</button>`).join('');
                addItemModal.classList.remove('hidden');
            }
            addItemModal.addEventListener('click', e => { if (e.target.classList.contains('item-select-btn')) { addItemToSession(currentDeviceToAddItem, e.target.dataset.name, parseFloat(e.target.dataset.price)); } });
            function hideAddItemModal() { addItemModal.classList.add('hidden'); }

            function showEndSessionConfirmation(deviceName) {
                currentDeviceToEnd = deviceName;
                document.getElementById('end-modal-device-name').textContent = deviceName;
                endSessionModal.classList.remove('hidden');
            }
            function hideEndSessionConfirmation() { endSessionModal.classList.add('hidden'); }
            
            document.getElementById('cancel-start-session').addEventListener('click', hideStartSessionModal);
            document.getElementById('cancel-add-item').addEventListener('click', hideAddItemModal);
            document.getElementById('cancel-end-session').addEventListener('click', hideEndSessionConfirmation);
            document.getElementById('confirm-end-session').addEventListener('click', () => { if (currentDeviceToEnd) endSession(currentDeviceToEnd); hideEndSessionConfirmation(); });
            
            startSessionModal.addEventListener('click', (e) => {
                if (e.target.classList.contains('time-option-btn')) {
                    document.querySelectorAll('.time-option-btn').forEach(btn => btn.classList.replace('btn-primary', 'btn-secondary'));
                    e.target.classList.replace('btn-secondary', 'btn-primary');
                    document.getElementById('manual-time-input-container').classList.toggle('hidden', e.target.dataset.minutes !== 'manual');
                }
            });

            document.getElementById('start-session-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const sessionType = document.querySelector('input[name="sessionType"]:checked').value;
                const customerName = document.getElementById('customer-name').value;
                const selectedTimeBtn = document.querySelector('.time-option-btn.btn-primary');
                const minutes = selectedTimeBtn ? (selectedTimeBtn.dataset.minutes === 'manual' ? parseInt(document.getElementById('manual-minutes').value) || 0 : parseInt(selectedTimeBtn.dataset.minutes)) : 0;
                startSession(currentDeviceToStart.name, currentDeviceToStart.type, sessionType, minutes, customerName);
            });

             // --- GEMINI API ---
            async function generateShiftSummary(shiftIndex) {
                const summaryLoader = document.getElementById('summary-loader');
                const summaryContent = document.getElementById('summary-content');

                summaryModal.classList.remove('hidden');
                summaryLoader.classList.remove('hidden');
                summaryContent.textContent = '';

                const shift = appState.shiftHistory[shiftIndex];
                if (!shift) {
                    summaryContent.textContent = "خطأ: لم يتم العثور على بيانات الشيفت.";
                    summaryLoader.classList.add('hidden');
                    return;
                }
                
                const startTime = new Date(shift.startTime).toLocaleString('ar-EG');
                const endTime = new Date(shift.endTime).toLocaleString('ar-EG');
                const netProfit = shift.revenue - shift.expenses;

                const userPrompt = `
                    أنت مساعد مدير لسايبر كافيه. بناءً على البيانات التالية لشيفت عمل، قم بكتابة ملخص قصير ومحترف باللغة العربية في فقرة واحدة. 
                    اذكر اسم الموظف، وصافي الربح، مع تقديم ملاحظة بسيطة عن أداء الشيفت (مثلاً: "شيفت ناجح" أو "أداء متوسط").

                    البيانات:
                    - الموظف: ${shift.user}
                    - بداية الشيفت: ${startTime}
                    - نهاية الشيفت: ${endTime}
                    - إجمالي الإيرادات: ${shift.revenue.toFixed(2)} جنيه
                    - صافي الربح: ${netProfit.toFixed(2)} جنيه
                `;
                
                const apiKey = ""; // API key will be injected by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userPrompt }] }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();
                    const summaryText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (summaryText) {
                        summaryContent.textContent = summaryText;
                    } else {
                        throw new Error("No content received from API.");
                    }

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    summaryContent.textContent = "عذرًا، حدث خطأ أثناء إنشاء الملخص. يرجى المحاولة مرة أخرى.";
                } finally {
                    summaryLoader.classList.add('hidden');
                }
            }

            document.getElementById('close-summary-modal').addEventListener('click', () => {
                summaryModal.classList.add('hidden');
            });


            // --- ADMIN & NOTIFICATION PANEL ---
            function renderNotifications() {
                const unreadCount = appState.notifications.filter(n => !n.read).length;
                notificationBadge.textContent = unreadCount;
                notificationBadge.classList.toggle('hidden', unreadCount === 0);
                
                notificationList.innerHTML = appState.notifications.map(n => {
                    const time = new Date(n.timestamp).toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'});
                    return `<div class="p-2 border-b border-gray-700 text-sm ${n.read ? 'text-gray-500' : 'text-main'}">
                        <p>${n.message}</p>
                        <p class="text-xs text-gray-400 text-left">${time}</p>
                    </div>`
                }).join('') || `<p class="p-4 text-center text-gray-500">لا توجد إشعارات</p>`;
            }

            notificationBellBtn.addEventListener('click', () => {
                notificationPanel.classList.toggle('hidden');
                if (!notificationPanel.classList.contains('hidden')) {
                    appState.notifications.forEach(n => n.read = true);
                    saveState();
                    renderNotifications(); // Re-render to update style and remove badge
                }
            });
            
            adminPanelBtn.addEventListener('click', () => {
                activityLogFilter = null;
                renderAdminPanel();
                adminModal.classList.remove('hidden');
            });
            document.getElementById('close-admin-modal').addEventListener('click', () => adminModal.classList.add('hidden'));

            function renderAdminPanel() {
                renderUserManagementTab();
                renderActivityLogTab();
                renderShiftHistoryTab();
                switchTab('user-management');
            }
            
            function switchTab(tabId) {
                document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                    const isSelected = btn.dataset.tab === tabId;
                    btn.classList.toggle('border-primary', isSelected);
                    btn.classList.toggle('text-gray-400', !isSelected);
                    btn.classList.toggle('border-transparent', !isSelected);
                });
                document.querySelectorAll('.admin-tab-content').forEach(content => {
                    content.classList.toggle('hidden', content.id !== `${tabId}-tab`);
                });
            }

            function renderUserManagementTab() {
                const container = document.getElementById('user-list-container');
                container.innerHTML = Object.entries(appState.users).map(([email, userData]) => `
                    <div class="bg-gray-800 p-4 rounded-lg flex justify-between items-center">
                        <div>
                            <p class="font-bold">${userData.name}</p>
                            <p class="text-sm text-gray-400">${email}</p>
                        </div>
                        <div class="flex gap-2 items-center">
                             <button class="monitor-activity-btn btn-primary px-3 py-1 rounded" data-email="${email}">مراقبة النشاط</button>
                            <div class="change-password-container">
                                <button class="change-pass-btn btn-secondary px-3 py-1 rounded">تغيير كلمة المرور</button>
                                <div class="password-fields hidden flex gap-2 items-center">
                                    <input type="password" placeholder="كلمة المرور الجديدة" class="new-password-input bg-gray-700 p-1 rounded">
                                    <button class="save-pass-btn btn-primary px-3 py-1 rounded">حفظ</button>
                                    <button class="cancel-pass-btn btn-danger px-3 py-1 rounded">X</button>
                                </div>
                            </div>
                        </div>
                    </div>`
                ).join('');
            }

            document.getElementById('user-list-container').addEventListener('click', (e) => {
                const target = e.target;
                if(target.classList.contains('monitor-activity-btn')) {
                    activityLogFilter = target.dataset.email;
                    switchTab('activity-log');
                    renderActivityLogTab();
                }
                const container = target.closest('.change-password-container');
                if (!container) return;
                if (target.classList.contains('change-pass-btn')) {
                    container.querySelector('.change-pass-btn').classList.add('hidden');
                    container.querySelector('.password-fields').classList.remove('hidden');
                }
                if (target.classList.contains('cancel-pass-btn')) {
                    container.querySelector('.change-pass-btn').classList.remove('hidden');
                    container.querySelector('.password-fields').classList.add('hidden');
                }
                if (target.classList.contains('save-pass-btn')) {
                    const email = container.closest('.bg-gray-800').querySelector('.text-sm').textContent;
                    const newPassword = container.querySelector('.new-password-input').value;
                    if (newPassword && newPassword.length >= 6) {
                        appState.users[email].password = newPassword;
                        saveState();
                        logActivity('تغيير كلمة المرور', { forUser: email });
                        showNotification(`تم تغيير كلمة مرور ${email} بنجاح.`);
                        container.querySelector('.cancel-pass-btn').click();
                    } else {
                        showNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل.');
                    }
                }
            });

            function renderActivityLogTab() {
                const container = document.getElementById('activity-log-container');
                const title = document.getElementById('activity-log-title');
                const showAllBtn = document.getElementById('show-all-activity-btn');
                let logsToShow = activityLogFilter ? appState.activityLog.filter(log => log.user === activityLogFilter) : appState.activityLog;
                title.textContent = activityLogFilter ? `سجل نشاط المستخدم: ${activityLogFilter}`: 'سجل النشاط (آخر 100 حركة)';
                showAllBtn.classList.toggle('hidden', !activityLogFilter);
                container.innerHTML = logsToShow.map(log => {
                    const logTime = new Date(log.timestamp).toLocaleString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    const details = Object.entries(log.details).map(([key, value]) => `${key}: ${value}`).join(' | ');
                    return `<div class="bg-gray-800 p-2 rounded flex items-start"><span class="text-accent ml-3">[${logTime}]</span><div class="flex-grow"><span class="text-warn font-bold">${log.user}</span>: <span class="text-main">${log.action}</span>${details ? `<span class="text-gray-400 text-xs block">${details}</span>` : ''}</div></div>`;
                }).join('') || `<p class="text-gray-500">لا يوجد نشاط مسجل.</p>`;
            }
            
            function renderShiftHistoryTab() {
                const container = document.getElementById('shift-history-container');
                 container.innerHTML = appState.shiftHistory.map((shift, index) => {
                    const startTime = new Date(shift.startTime).toLocaleString('ar-EG');
                    const endTime = new Date(shift.endTime).toLocaleString('ar-EG');
                    const net = shift.revenue - shift.expenses;
                    return `
                        <div class="bg-gray-800 p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold text-lg">الموظف: <span class="text-primary">${shift.user}</span></p>
                                </div>
                                <button class="generate-summary-btn btn-primary px-3 py-1 rounded text-sm" data-shift-index="${index}">✨ تلخيص الشيفت</button>
                            </div>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2 text-center">
                                <div><p class="text-gray-400 text-sm">بداية الشيفت</p><p>${startTime}</p></div>
                                <div><p class="text-gray-400 text-sm">نهاية الشيفت</p><p>${endTime}</p></div>
                                <div><p class="text-gray-400 text-sm">الإيرادات</p><p class="text-accent font-bold">${shift.revenue.toFixed(2)}</p></div>
                                <div><p class="text-gray-400 text-sm">الصافي</p><p class="text-white font-bold">${net.toFixed(2)}</p></div>
                            </div>
                        </div>`;
                 }).join('') || `<p class="text-gray-500">لا يوجد شيفتات مسجلة بعد.</p>`;
            }
            
            document.getElementById('shift-history-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('generate-summary-btn')) {
                    const shiftIndex = parseInt(e.target.dataset.shiftIndex, 10);
                    generateShiftSummary(shiftIndex);
                }
            });


            document.getElementById('show-all-activity-btn').addEventListener('click', () => {
                activityLogFilter = null;
                renderActivityLogTab();
            });

            document.querySelectorAll('.admin-tab-btn').forEach(button => {
                button.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
            });

            // --- INITIALIZATION ---
            loadState();
            checkLogin();
        });
    </script>
</body>
</html>


